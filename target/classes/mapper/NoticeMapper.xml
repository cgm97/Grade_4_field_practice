<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="noticeMapper">
 
   <!-- 게시판 목록 조회 -->
   <select id="getBoardList"  parameterType="HASHMAP" resultType="boardDTO">
<!-- 	  	 SELECT CON_DIV, CON_NO, CON_TITLE, CON_TXT, CON_ID, PASSWORD,
	  	 		READ_COUNT, TO_CHAR(REG_DATE,'MM-DD HH24:MI:SS') as REG_DATE, UPD_DATE 
	  	 	FROM CONTENTS_DATA 
	  	 		WHERE CON_DIV = #{board.con_div} AND DEL_YN='N' ORDER BY ABS(CON_NO) DESC -->
	  	<!--  SELECT * from (
	  	 		SELECT ROWNUM RN, A.* from ( SELECT CON_DIV, CON_NO, CON_TITLE, CON_TXT, CON_ID, PASSWORD,
	  	 			READ_COUNT, TO_CHAR(REG_DATE,'MM-DD HH24:MI:SS') as REG_DATE, UPD_DATE 
	  	 				FROM CONTENTS_DATA
	  	 		WHERE <![CDATA[ROWNUM < #{cri.rowEnd}]]> AND CON_DIV = #{board.con_div} AND DEL_YN='N' 
	  	 			ORDER BY ABS(CON_NO) DESC) A)
        		WHERE <![CDATA[RN >= #{cri.rowStart}]]> -->  		
        	 SELECT rNum RN, CON_DIV, CON_NO, CON_TITLE, CON_TXT, CON_ID, PASSWORD, READ_COUNT, REG_DATE, UPD_DATE 
                FROM(
                    SELECT CON_DIV, CON_NO, CON_TITLE, CON_TXT, CON_ID, PASSWORD, 
                            READ_COUNT, TO_CHAR(REG_DATE,'MM-DD HH24:MI:SS') as REG_DATE, UPD_DATE,
                            row_number() over(order by ABS(CON_NO) DESC) as rNum
                        FROM contents_data WHERE CON_DIV = #{board.con_div} AND DEL_YN='N' ) A
                    WHERE rNum BETWEEN 
                   	 #{cri.rowStart} AND #{cri.rowEnd}
                    	 order by ABS(CON_NO) DESC
	  	 
   </select>
    <!-- 게시물 상세보기 -->
    <select id="getContentByCon_No" parameterType="boardDTO" resultType="boardDTO">
	  	 SELECT CON_NO, CON_TITLE, CON_TXT	 		
	  	 	FROM CONTENTS_DATA 
	  	 		WHERE CON_DIV = #{con_div} AND CON_NO = #{con_no}
   </select>
   <!-- 조회수 카운팅 -->
   <update id="plusReadCount" parameterType="boardDTO">
    	UPDATE CONTENTS_DATA 
    		SET READ_COUNT = READ_COUNT+1 
    			WHERE CON_NO = #{con_no}
   </update>
   <!-- 글쓰기 -->
   <insert id="insertBoard" parameterType="boardDTO">
   		INSERT INTO CONTENTS_DATA (CON_DIV, CON_NO, CON_TITLE, CON_TXT, CON_ID, PASSWORD, REG_IP) 
   			 VALUES (#{con_div}, (SELECT NVL(MAX(ABS(CON_NO))+1,1) 
   			 	FROM CONTENTS_DATA), #{con_title}, #{con_txt}, #{con_id}, #{password}, #{reg_ip})
   </insert>
   <!-- 본인 인증 -->
   <select id="isCheckIdentify" parameterType="boardDTO" resultType="boolean">
   		SELECT CASE WHEN count(*)=1 THEN 1 ELSE 0 END
   			FROM CONTENTS_DATA
   				WHERE CON_DIV = #{con_div} AND CON_NO = #{con_no} AND CON_ID = #{con_id} AND PASSWORD = #{password}
   	</select>
   	<!-- 글 수정 -->
	<update id="updateBoard" parameterType="boardDTO" >
		UPDATE CONTENTS_DATA 
			SET CON_TITLE = #{con_title}, CON_TXT = #{con_txt}, UPD_DATE = SYSDATE
				WHERE CON_DIV = #{con_div} AND CON_NO = #{con_no} 
	</update>
	<!-- 글 삭제  DELETE 구문 사용이 아닌 UPDATE 사용 , 게시물 삭제 해도 데이터 남기기 위함-->
	<delete id="deleteBoard" parameterType="boardDTO">
<!-- 	DELETE 
			FROM CONTENTS_DATA
				WHERE CON_DIV = #{con_div} AND CON_NO = #{con_no} 	 -->
		UPDATE CONTENTS_DATA
			SET DEL_YN = 'Y'
				WHERE CON_DIV = #{con_div} AND CON_NO = #{con_no}				
	</delete>
	<!-- 게시판 검색 목록 조회 -->
	<select id="selectSearchBoardList"  parameterType="HASHMAP" resultType="boardDTO">
		SELECT rNum RN, CON_DIV, CON_NO, CON_TITLE, CON_TXT, CON_ID, PASSWORD, READ_COUNT, REG_DATE, UPD_DATE 
	                FROM(
	                    SELECT CON_DIV, CON_NO, CON_TITLE, CON_TXT, CON_ID, PASSWORD, 
	                            READ_COUNT, TO_CHAR(REG_DATE,'MM-DD HH24:MI:SS') as REG_DATE, UPD_DATE,
	                            row_number() over(order by ABS(CON_NO) DESC) as rNum
	                        FROM contents_data 
	                    WHERE CON_DIV = #{search.con_div} AND DEL_YN='N' AND
 			<if test= 'search.search_option eq "title" '>
		 				CON_TITLE 
			</if>
			<if test= 'search.search_option eq "id" '>
		 				CON_ID
			</if>	
			LIKE '%'||#{search.keyword}||'%') A	
				 WHERE rNum BETWEEN 
                   	 #{cri.rowStart} AND #{cri.rowEnd}
                    	 order by ABS(CON_NO) DESC
	</select>
	<!-- 게시판 목록 총 갯수 조회 -->
	<select id="countBoardList" parameterType="com.joyandbiz.board.domain.SearchDTO" resultType="integer">
		SELECT COUNT(*)
			FROM CONTENTS_DATA
				WHERE CON_DIV = #{con_div} AND DEL_YN='N'
				<if test= 'search_option eq "title" '> <!-- 검색 조건에 해당되는 게시물 갯수 -->
					AND CON_TITLE LIKE '%'||#{keyword}||'%'
				</if>
				<if test= 'search_option eq "id" '>
					AND CON_ID LIKE '%'||#{keyword}||'%'
				</if>
	</select>
</mapper>